version: '3.4'
services:
# Reverse proxy & Front end
  traefik:
    container_name: $STACK-$TRAEFIK
    image: traefik
    command: --api # Enables the web UI
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$TRAEFIK.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=8080"
    ports:
      - "80:80" # The HTTP port
      - "443:443" # The HTTPS port
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # So that Traefik can listen to the Docker events
      - ./config/traefik.toml:/traefik.toml # Traefik configuration file
      - $APPDATA/$STACK/$TRAEFIK/traefik-acme:/acme # Tell Traefik to save SSL certs here
    networks:
      - net

  organizr:
    container_name: $STACK-$ORGANIZR
    image: organizrtools/organizr-v2
    restart: always
    depends_on:
      - traefik
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$ORGANIZR.$DOMAIN" # Domain name for the app
      - "traefik.port=80"
    ports:
      - "8888:80"
    environment:
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$ORGANIZR:/config
    networks:
      - net

# Streaming & Compainion apps
  emby:
    container_name: $STACK-$EMBY
    image: emby/embyserver
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$EMBY.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=999"
      - "traefik.port=8096"
    ports:
      -  "8096:8096"
    environment:
      - PGID=$GROUPID
      - PUID=$USERID
      - GIDLIST=$GROUPID
    volumes:
      - $APPDATA/$STACK/$EMBY:/config
      - $MEDIA:/data/media
    networks:
      - net

  # jellyfin:
  #   container_name: $STACK-$JELLYFIN
  #   image: linuxserver/jellyfin
  #   restart: always
  #    depends_on:
  #      - traefik
  #      - organizr
  #   ports:
  #     - 8097:8096
  #   environment:
  #     - TZ=$TIMEZONE
  #     - PGID=$GROUPID
  #     - PUID=$USERID
  #   volumes:
  #     - $APPDATA/$STACK/$JELLYFIN:/config
  #     - $MEDIA:/data/media
  #   networks:
  #     - net

  airsonic:
    container_name: $STACK-$AIRSONIC
    image: linuxserver/airsonic
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$AIRSONIC.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=4"
      - "traefik.port=4040"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$AIRSONIC:/config
      - $MEDIA/music:/data/music
      - $MEDIA/playlists:/data/playlists
      - $MEDIA/podcasts:/data/podcasts
    networks:
      - net

  ombi:
    container_name: $STACK-$OMBI
    image: linuxserver/ombi
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$OMBI.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=999"
      - "traefik.port=3579"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$OMBI:/config
    networks:
      - net

  omv:
    image: qoomon/docker-host
    container_name: $STACK-$HOSTAPP
    restart: always
    cap_add: [ 'NET_ADMIN', 'NET_RAW' ]
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$HOSTAPP.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=$HOSTPORT"
    expose:
      - "$HOSTPORT"
    networks:
      - net

# Indexer apps
  sonarr:
    container_name: $STACK-$SONARR
    image: linuxserver/sonarr:preview
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$SONARR.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=8989"
    ports:
      - "8989:8989"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$SONARR:/config
      - $MEDIA/temp:/data/temp
      - $MEDIA/tvshows:/data/tv
      - $DOWNLOADS/torrent:/data/downloads/torrent
      - $DOWNLOADS/usenet:/data/downloads/usenet
    networks:
      - net

  radarr:
    container_name: $STACK-$RADARR
    image: linuxserver/radarr:nightly
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$RADARR.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=7878"
    ports:
      - "7878:7878"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$RADARR:/config
      - $MEDIA/temp:/data/temp
      - $MEDIA/movies:/data/movies
      - $DOWNLOADS/torrent:/data/downloads/torrent
      - $DOWNLOADS/usenet:/data/downloads/usenet
    networks:
      - net

  radarr-collection:
    container_name: $STACK-$RADARRCOLLECTION
    image: si0972/radarr-collections
    restart: always
    depends_on:
      - traefik
    # labels:
    #   - "traefik.enable=true" # Enable reverse-proxy for this service
    #   - "traefik.frontend.rule=Host:$RADARRCOLLECTION.$DOMAIN" # Domain name for the app
    #   - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
    #   - "traefik.port=7878"
    environment:
      - PGID=$GROUPID
      - PUID=$USERID
      - args=$ARGS
    volumes:
      - $APPDATA/$STACK/$RADARRCOLLECTION:/config
    networks:
      - net

  lidarr:
    container_name: $STACK-$LIDARR
    image: linuxserver/lidarr
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$LIDARR.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=8686"
    ports:
      - "8686:8686"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$LIDARR:/config
      - $MEDIA/temp:/data/temp
      - $DOWNLOADS/torrent:/data/downloads/torrent
      - $DOWNLOADS/usenet:/data/downloads/usenet
      - $MEDIA/music:/data/music
    networks:
      - net

# Indexer source apps
  jackett:
    container_name: $STACK-$JACKETT
    image: linuxserver/jackett:development
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$JACKETT.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=9117"
    ports:
      - "9117:9117"
    environment:
      - TZ=$TIMEZONE
      - PGID=$GROUPID
      - PUID=$USERID
    volumes:
      - $APPDATA/$STACK/$JACKETT:/config
      - $DOWNLOADS/torrent:/data/downloads/torrent
      - $DOWNLOADS/usenet:/data/downloads/usenet
    networks:
      - net

# Torrent download clients
  transmission:
    container_name: $STACK-$TRANSMISSION
    image: haugene/transmission-openvpn
    restart: always
    cap_add:
      - NET_ADMIN
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$TRANSMISSION.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=9091"
    ports:
      - 9091:9091
    environment:
      - PGID=$GROUPID
      - PUID=$USERID
      - CREATE_TUN_DEVICE=$CREATE_TUN_DEVICE
      - OPENVPN_PROVIDER=$OPENVPN_PROVIDER
      - OPENVPN_CONFIG=$OPENVPN_CONFIG
      - OPENVPN_USERNAME=$OPENVPN_USERNAME
      - OPENVPN_PASSWORD=$OPENVPN_PASSWORD
      - OPENVPN_OPTS=$OPENVPN_OPTS
      - NORDVPN_PROTOCOL=$NORDVPN_PROTOCOL
      - NORDVPN_CATEGORY=$NORDVPN_CATEGORY
      - WEBPROXY_ENABLED=false
      - LOCAL_NETWORK=$LOCAL_NETWORK
      - TRANSMISSION_DOWNLOAD_DIR=$TRANSMISSION_DOWNLOAD_DIR
      - TRANSMISSION_SCRAPE_PAUSED_TORRENTS_ENABLED=false
      - TRANSMISSION_RATIO_LIMIT_ENABLED=$TRANSMISSION_RATIO_LIMIT_ENABLED
      - TRANSMISSION_RATIO_LIMIT=$TRANSMISSION_RATIO_LIMIT
      - TRANSMISSION_IDLE_SEEDING_LIMIT_ENABLED=$TRANSMISSION_IDLE_SEEDING_LIMIT_ENABLED
      - TRANSMISSION_IDLE_SEEDING_LIMIT=$TRANSMISSION_IDLE_SEEDING_LIMIT
      - TRANSMISSION_DOWNLOAD_QUEUE_ENABLED=$TRANSMISSION_DOWNLOAD_QUEUE_ENABLED
      - TRANSMISSION_DOWNLOAD_QUEUE_SIZE=$TRANSMISSION_DOWNLOAD_QUEUE_SIZE
      - TRANSMISSION_PORT_FORWARDING_ENABLED=$TRANSMISSION_PORT_FORWARDING_ENABLED
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $DOWNLOADS/torrent:/data/downloads/torrent
    networks:
      - net

# Usenet download clients
  nzbget:
    image: "linuxserver/nzbget:testing"
    container_name: $STACK-$NZBGET
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$NZBGET.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=6789"
    ports:
      - 6789:6789
    environment:
      - PUID=$USERID
      - PGID=$GROUPID
      - TZ=$TIMEZONE
    volumes:
      - $APPDATA/$STACK/$NZBGET:/config
      - $DOWNLOADS/usenet:/data/downloads/usenet
    networks:
      - net

# Utility services
  ddclient:
    image: "linuxserver/ddclient"
    container_name: $STACK-ddclient
    restart: always
    environment:
      - PUID=$USERID
      - PGID=$GROUPID
      - TZ=$TIMEZONE
    volumes:
      - $APPDATA/$STACK/ddclient:/config
    networks:
      - net

  portainer:
    image: "portainer/portainer"
    container_name: $STACK-$PORTAINER
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$PORTAINER.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $APPDATA/$STACK/$PORTAINER:/data
    networks:
      - net

# Monitoring & Analytic apps
  # Container update manager
  watchtower:
    container_name: $STACK-watchtower
    image: v2tec/watchtower
    restart: unless-stopped
    command: --schedule "0 0 4 * * *" --cleanup
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - net

# Self hosted gitlab complete ci pipeline
  gitlab:
    image: "gitlab/gitlab-ce:latest"
    container_name: $STACK-$GITLAB
    hostname: $GITLAB.$DOMAIN
    restart: always
    depends_on:
      - traefik
      - organizr
    labels:
      - "traefik.enable=true" # Enable reverse-proxy for this service
      - "traefik.frontend.rule=Host:$GITLAB.$DOMAIN" # Domain name for the app
      - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
      - "traefik.port=80"
    ports:
      - "2222:22"
    volumes:
      - $APPDATA/$STACK/$GITLAB/config:/etc/gitlab
      - $APPDATA/$STACK/$GITLAB/logs:/var/log/gitlab
      - $APPDATA/$STACK/$GITLAB/data:/var/opt/gitlab
    networks:
      - net

# Openldap server
  openldap:
    image: "osixia/openldap"
    container_name: $STACK-$OPENLDAP
    hostname: $OPENLDAP.$DOMAIN
    restart: always
    depends_on:
      - traefik
    tty: true
    stdin_open: true
    ports:
      - "389:389"
      - "636:636"
    environment:
      - LDAP_TLS=$LDAP_TLS
      - LDAP_ORGANISATION=$LDAP_ORGANISATION
      - LDAP_DOMAIN=$DOMAIN
      - LDAP_ADMIN_PASSWORD=$LDAP_ADMIN_PASSWORD
    volumes:
      - $APPDATA/$STACK/$OPENLDAP/data:/var/lib/ldap
      - $APPDATA/$STACK/$OPENLDAP/config:/etc/ldap/slapd.d
      - $APPDATA/$STACK/$OPENLDAP/certs:/container/service/slapd/assets/certs/
    networks:
      - net

# LDAP account manager
  # phpldapadmin:
  #   image: "osixia/phpldapadmin"
  #   container_name: $STACK-$PHPLDAPADMIN
  #   depends_on:
  #     - traefik
  #     - organizr
  #     - openldap
  #   labels:
  #     - "traefik.enable=true" # Enable reverse-proxy for this service
  #     - "traefik.frontend.rule=Host:$PHPLDAPADMIN.$DOMAIN" # Domain name for the app
  #     - "traefik.frontend.auth.forward.address=http://organizr/api/?v1/auth&group=1"
  #     - "traefik.port=80"
  #   environment:
  #     - PHPLDAPADMIN_LDAP_HOSTS=$OPENLDAP.$DOMAIN
  #     - PHPLDAPADMIN_HTTPS=false
  #   networks:
  #     - net

networks:
  net:
    internal: false
